{% extends "base.html" %}
{% block title %}Guardias - Agencia de Guardias{% endblock %}

{% block content %}
<h3>Guardias</h3>
<p class="text-muted">Listado básico de guardias (solo lectura).</p>
<div class="table-responsive">
  <table class="table table-sm table-striped align-middle">
    <thead>
      <tr><th>ID</th><th>Apellido, Nombre</th><th>Sede</th><th>Activo</th><th>Acciones</th></tr>
    </thead>
    <tbody>
      {% for g in guardias %}
      <tr>
        <td>{{ g.guardia_id }}</td>
        <td>{{ g.apellidos }}, {{ g.nombres }}</td>
        <td>{{ g.sede_nombre }}</td>
        <td>{{ g.activo }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="4" class="text-muted">No hay guardias.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<div class="d-flex gap-2 mt-3">
  <button class="btn btn-sm btn-primary" id="btn-crear-guardia">Crear guardia</button>
  <button class="btn btn-sm btn-secondary" id="btn-refrescar-guardias">Refrescar</button>
</div>

<!-- Modal Crear Guardia -->
<div class="modal fade" id="modalGuardia" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="form-guardia">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Crear nueva guardia</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Sede</label>
            <select name="sede_id" class="form-select" id="select-sedes"></select>
          </div>
          <div class="mb-3 row">
            <div class="col-6">
              <label class="form-label">Apellidos</label>
              <input name="apellidos" class="form-control" required>
            </div>
            <div class="col-6">
              <label class="form-label">Nombres</label>
              <input name="nombres" class="form-control" required>
            </div>
          </div>
          <div class="mb-3 row">
            <div class="col-6">
              <label class="form-label">Sueldo</label>
              <input name="sueldo" type="number" step="0.01" class="form-control" value="1200" required>
            </div>
            <div class="col-6">
              <label class="form-label">Orden rotativo</label>
              <input name="orden_rotativo" type="number" class="form-control" value="1" required>
            </div>
          </div>
          <div id="guardia-msg" class="small"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Crear</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const modalEl = document.getElementById('modalGuardia');
  const modal = new bootstrap.Modal(modalEl);
  const btnCrear = document.getElementById('btn-crear-guardia');
  const btnRef = document.getElementById('btn-refrescar-guardias');
  const tbody = document.querySelector('table tbody');
  const selectSedes = document.getElementById('select-sedes');
  const form = document.getElementById('form-guardia');
  const msg = document.getElementById('guardia-msg');

  async function cargarSedes() {
    try {
      const res = await api('/api/sedes/');
      const list = res.sedes || [];
      selectSedes.innerHTML = list.map(s => `<option value="${s.sede_id}">${s.nombre} (${s.ciudad})</option>`).join('');
    } catch (e) {
      selectSedes.innerHTML = '<option value="">Error cargando sedes</option>';
    }
  }

  async function cargarGuardias() {
    try {
      const res = await api('/api/guardias/');
      const list = res.guardias || [];
      const rows = list.map(g => `
        <tr>
          <td>${g.guardia_id}</td>
          <td>${g.apellidos}, ${g.nombres}</td>
          <td>${g.sede_nombre||''}</td>
          <td>${g.activo}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary btn-editar-guardia" 
                    data-id="${g.guardia_id}"
                    data-apellidos="${g.apellidos}"
                    data-nombres="${g.nombres}"
                    data-sueldo="${g.sueldo}"
                    data-orden="${g.orden_rotativo}"
                    data-sede="${g.sede_id}">Editar</button>
            <button class="btn btn-sm btn-outline-danger btn-baja" data-id="${g.guardia_id}">Dar baja</button>
            <button class="btn btn-sm btn-outline-danger btn-eliminar-guardia" data-id="${g.guardia_id}">Eliminar</button>
          </td>
        </tr>
      `).join('');
      tbody.innerHTML = rows;
    } catch (e) {
      tbody.innerHTML = `<tr><td colspan="5" class="text-danger">${e.message||e}</td></tr>`;
    }
  }

  btnCrear.addEventListener('click', async () => { await cargarSedes(); delete form.dataset.editId; modal.show(); });
  btnRef.addEventListener('click', cargarGuardias);

  form.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    msg.textContent = '';
    const fd = new FormData(form);
    const payload = {
      sede_id: Number(fd.get('sede_id')),
      apellidos: fd.get('apellidos'),
      nombres: fd.get('nombres'),
      sueldo: Number(fd.get('sueldo')),
      orden_rotativo: Number(fd.get('orden_rotativo'))
    };
    try {
      if (form.dataset.editId) {
        const id = form.dataset.editId;
        await api(`/api/guardias/${encodeURIComponent(id)}/editar/`, { method: 'POST', body: JSON.stringify(payload) });
        msg.textContent = 'Guardia actualizada.'; msg.className='text-success';
      } else {
        await api('/api/guardias/alta/', { method: 'POST', body: JSON.stringify(payload) });
        msg.textContent = 'Guardia creada.'; msg.className='text-success';
      }
      setTimeout(()=>{ modal.hide(); cargarGuardias(); }, 600);
    } catch (e) {
      msg.textContent = e.message || e; msg.className='text-danger';
    }
  });

  // Delegación para acciones (baja / editar)
  document.addEventListener('click', async (ev) => {
    const btnDel = ev.target.closest('.btn-eliminar-guardia');
    if (btnDel) {
      const id = btnDel.dataset.id;
      try {
        const info = await api(`/api/guardias/${encodeURIComponent(id)}/eliminar/info/`);
        // construir modal simple on the fly
        const html = `
          <div class="modal fade" id="modalEliminarGuardia" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog"><div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Eliminar guardia ${id}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <div class="modal-body">
                <p>Turnos asociados: <b>${info.turnos ?? '-'}</b></p>
                <div class="alert alert-warning ${((info.turnos||0)>0)?'':'d-none'}">Existen turnos asociados. La eliminación fallará por integridad referencial si no se eliminan primero.</div>
                <div id="del-guardia-msg" class="small"></div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btn-confirm-eliminar-guardia">Eliminar</button>
              </div>
            </div></div>
          </div>`;
        let container = document.getElementById('modalEliminarGuardia');
        if (container) container.remove();
        document.body.insertAdjacentHTML('beforeend', html);
        const modalEl = document.getElementById('modalEliminarGuardia');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        modalEl.addEventListener('click', async (e2) => {
          if (e2.target && e2.target.id === 'btn-confirm-eliminar-guardia') {
            const msgDel = document.getElementById('del-guardia-msg');
            msgDel.textContent = '';
            try {
              await api(`/api/guardias/${encodeURIComponent(id)}/eliminar/`, { method: 'POST' });
              msgDel.textContent = 'Guardia eliminada.'; msgDel.className='small text-success';
              setTimeout(()=> { modal.hide(); cargarGuardias(); }, 500);
            } catch (err) {
              msgDel.textContent = err.message || err; msgDel.className='small text-danger';
            }
          }
        }, { once: true });
      } catch (e) {
        if (!confirm('No se pudo obtener el detalle. ¿Desea intentar eliminar igualmente?')) return;
        try {
          await api(`/api/guardias/${encodeURIComponent(id)}/eliminar/`, { method: 'POST' });
          cargarGuardias();
        } catch (err) { alert('No fue posible eliminar la guardia: ' + (err.message || err)); }
      }
      return;
    }

    const btnBaja = ev.target.closest('.btn-baja');
    if (btnBaja) {
      const id = btnBaja.dataset.id;
      if (!confirm(`¿Dar baja a la guardia ${id}?`)) return;
      
      // Opcional: preguntar por ciclo desde el cual dar baja
      const desdeCiclo = prompt('Desde ciclo (opcional, formato YYYY-MM-DD HH:MM):', '');
      const payload = { guardia_id: Number(id) };
      if (desdeCiclo && desdeCiclo.trim()) {
        payload.desde_ciclo = desdeCiclo.trim();
      }
      
      try {
        await api('/api/guardias/baja/', { method: 'POST', body: JSON.stringify(payload) });
        alert('Guardia dada de baja exitosamente.');
        cargarGuardias();
      } catch (e) { 
        alert('Error al dar de baja: ' + (e.message || e)); 
      }
      return;
    }

    const btnEdit = ev.target.closest('.btn-editar-guardia');
    if (btnEdit) {
      // rellenar modal para editar
      form.dataset.editId = btnEdit.dataset.id;
      form.apellidos.value = btnEdit.dataset.apellidos || '';
      form.nombres.value = btnEdit.dataset.nombres || '';
      form.sueldo.value = btnEdit.dataset.sueldo || 1200;
      form.orden_rotativo.value = btnEdit.dataset.orden || 1;
      await cargarSedes();
      if (btnEdit.dataset.sede) form.sede_id.value = btnEdit.dataset.sede;
      modal.show();
    }
  });

  // carga inicial
  cargarGuardias();
});
</script>
{% endblock %}
