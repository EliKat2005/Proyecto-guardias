{% extends "base.html" %}
{% block title %}Inicio - Agencia de Guardias{% endblock %}

{% block content %}
<div class="row g-4 align-items-stretch">
  <div class="col-lg-5">
    <div class="card h-100 card-gradient">
      <div class="card-header fw-bold"><i class="bi bi-arrow-repeat me-2"></i>Generar rotación (24h)</div>
      <div class="card-body">
        <form id="form-gen" class="row g-3">
          {% csrf_token %}
          <div class="col-12">
            <label class="form-label">Sede</label>
            <select class="form-select" id="sede_id" required>
              <option value="">-- Seleccione una sede --</option>
              {% for s in sedes %}
                <option value="{{ s.sede_id }}">{{ s.nombre }} ({{ s.ciudad }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Ciclo (inicio del ciclo 24h)</label>
            <input type="datetime-local" class="form-control" id="ciclo" required>
            <div class="form-text">Ancla del ciclo de 24 horas</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Inicio (hora de arranque)</label>
            <input type="datetime-local" class="form-control" id="inicio" required>
            <div class="form-text">Normalmente igual que ciclo</div>
          </div>
          <div class="col-12">
            <button class="btn btn-primary w-100" type="submit">
              <i class="bi bi-play-circle me-2"></i>Generar rotación
            </button>
            <div id="gen-msg" class="mt-2 small text-center"></div>
          </div>
        </form>
        <hr/>
        <form id="form-del-rot" class="row g-3 mt-2">
          <div class="col-12">
            <label class="form-label">Eliminar rotación (sede + ciclo)</label>
          </div>
          <div class="col-md-6">
            <label class="form-label">Sede</label>
            <select class="form-select" id="del_rot_sede" required>
              <option value="">-- Sede --</option>
              {% for s in sedes %}
                <option value="{{ s.sede_id }}">{{ s.nombre }} ({{ s.ciudad }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Ciclo</label>
            <select class="form-select" id="del_rot_ciclo_sel" required>
              <option value="">-- Ciclo --</option>
            </select>
          </div>
          <div class="col-12">
            <button class="btn btn-outline-danger w-100" type="submit"><i class="bi bi-x-circle me-2"></i>Eliminar rotación</button>
            <div id="del-rot-msg" class="small mt-1"></div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-lg-7">
    <div class="card h-100">
      <div class="card-header fw-bold"><i class="bi bi-list-check me-2"></i>Consultar turnos de un ciclo</div>
      <div class="card-body">
        <form id="form-q" class="row g-3">
          {% csrf_token %}
          <div class="col-md-6">
            <label class="form-label">Sede</label>
            <select class="form-select" id="qsede" required>
              <option value="">-- Seleccione una sede --</option>
              {% for s in sedes %}
                <option value="{{ s.sede_id }}">{{ s.nombre }} ({{ s.ciudad }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Ciclo (fecha/hora del ciclo)</label>
            <select class="form-select" id="qciclo_sel" required>
              <option value="">-- Seleccione un ciclo --</option>
            </select>
          </div>
          <div class="col-12">
            <button class="btn btn-secondary w-100" type="submit">
              <i class="bi bi-search me-2"></i>Listar turnos
            </button>
          </div>
        </form>
        <hr/>
        <div id="turnos-box" class="d-none">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Turnos del ciclo</h5>
            <small class="text-muted">Al eliminar, se ajustan turnos vecinos automáticamente</small>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
              <thead>
                <tr>
                  <th>ID</th><th>Guardia</th><th>Inicio</th><th>Fin</th><th>Horas</th><th>Jornada</th><th></th>
                </tr>
              </thead>
              <tbody id="turnos-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<hr class="my-4"/>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span><i class="bi bi-clock-history me-2"></i>Eventos Recientes del Sistema</span>
    <button class="btn btn-sm btn-outline-secondary" id="btn-refresh-eventos">
      <i class="bi bi-arrow-clockwise"></i> Refrescar
    </button>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle" id="eventos-table">
        <thead>
          <tr>
            <th style="width: 20%">Fecha</th>
            <th style="width: 14%">Tipo</th>
            <th style="width: 8%">Sede</th>
            <th style="width: 10%">Guardia</th>
            <th style="width: 8%">Turno</th>
            <th>Detalle</th>
          </tr>
        </thead>
        <tbody id="eventos-tbody">
          <tr><td colspan="6" class="text-muted">Cargando eventos...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="d-flex justify-content-between mt-2 small">
      <div id="eventos-msg" class="text-muted">&nbsp;</div>
      <div>
        <span id="eventos-count" class="badge text-bg-secondary">0</span> eventos
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Elementos cacheados
  const tbody = document.getElementById('turnos-tbody');
  const turnosBox = document.getElementById('turnos-box');
  const eventosTbody = document.getElementById('eventos-tbody');
  const eventosCount = document.getElementById('eventos-count');
  const eventosMsg = document.getElementById('eventos-msg');
  const sedeSelect = document.getElementById('sede_id');
  const hintMax = document.getElementById('max_guardias_hint');
  const hintSlot = document.getElementById('slot_minutos_hint');
  const qsede = document.getElementById('qsede');
  const qcicloSel = document.getElementById('qciclo_sel');
  const btnRefreshEventos = document.getElementById('btn-refresh-eventos');
  const delRotSede = document.getElementById('del_rot_sede');
  const delRotCicloSel = document.getElementById('del_rot_ciclo_sel');

  // Helper para badges de tipo de evento
  function badgeTipo(tipo) {
    if (!tipo) return '<span class="badge text-bg-secondary">-</span>';
    const t = String(tipo).toUpperCase();
    const cls = t.includes('ERROR') ? 'danger' : t.includes('WARN') ? 'warning' : t.includes('INFO') ? 'primary' : 'secondary';
    return `<span class="badge text-bg-${cls}">${tipo}</span>`;
  }

  function getRowClass(tipo) {
    if (!tipo) return '';
    const t = String(tipo).toUpperCase();
    if (t.includes('ERROR')) return 'table-row-error';
    if (t.includes('WARN')) return 'table-row-warning';
    return '';
  }

  // Renderizar eventos como tabla
  function renderEventos(list) {
    if (!list?.length) {
      eventosTbody.innerHTML = '<tr><td colspan="6" class="text-muted">Sin eventos recientes.</td></tr>';
      eventosCount.textContent = '0';
      return;
    }
    
    // Limitar a los últimos 15 eventos en home
    const subset = list.slice(0, 15);
    
    const rows = subset.map(ev => {
      const detalle = ev.detalle ? String(ev.detalle) : '';
      const detalleShort = detalle.length > 80 ? (detalle.slice(0, 80) + '…') : detalle;
      const sede = ev.sede_id ?? '-';
      const guardia = ev.guardia_id ?? '-';
      const turno = ev.turno_id ?? '-';
      const rowClass = getRowClass(ev.tipo_evento);
      
      return `
        <tr class="${rowClass}">
          <td><i class="bi bi-calendar-week me-1 text-muted"></i>${ev.fecha_evento || '-'}</td>
          <td>${badgeTipo(ev.tipo_evento)}</td>
          <td>${sede !== '-' ? `<span class="badge rounded-pill text-bg-light">${sede}</span>` : '-'}</td>
          <td>${guardia !== '-' ? `<span class="badge rounded-pill text-bg-light">${guardia}</span>` : '-'}</td>
          <td>${turno !== '-' ? `<span class="badge rounded-pill text-bg-light">${turno}</span>` : '-'}</td>
          <td class="text-truncate" style="max-width: 380px;" title="${detalle.replace(/"/g,'&quot;')}">
            ${detalleShort.replace(/</g,'&lt;').replace(/>/g,'&gt;')}
          </td>
        </tr>
      `;
    }).join('');
    eventosTbody.innerHTML = rows;
    eventosCount.textContent = String(list.length);
  }

  // Cargar y mostrar eventos recientes
  async function cargarEventos() {
    eventosMsg.textContent = 'Cargando...';
    try {
      const data = await api('/api/reportes/eventos/');
      const eventos = data.eventos || [];
      renderEventos(eventos);
      eventosMsg.textContent = eventos.length ? `Mostrando últimos ${Math.min(eventos.length, 15)} evento(s)` : 'Sin eventos';
      eventosMsg.className = 'text-muted';
    } catch (e) {
      eventosTbody.innerHTML = `<tr><td colspan="6" class="text-danger">${e.message || String(e)}</td></tr>`;
      eventosMsg.textContent = 'Error al cargar eventos';
      eventosMsg.className = 'text-danger';
    }
  }
  cargarEventos();
  if (btnRefreshEventos) btnRefreshEventos.addEventListener('click', cargarEventos);

  // Mostrar metadatos de la sede seleccionada (si la API lo soporta)
  async function updateSedeHints(id) {
    if (!id) {
      hintMax.textContent = '—';
      hintSlot.textContent = '—';
      return;
    }
    try {
      const s = await api(`/api/sedes/${encodeURIComponent(id)}/`);
      hintMax.textContent = s.max_guardias ?? s.max_guardias_permitidos ?? '—';
      hintSlot.textContent = s.slot_minutos ?? s.slot_min ?? '—';
    } catch (e) {
      // not critical
      hintMax.textContent = '—';
      hintSlot.textContent = '—';
    }
  }
  if (sedeSelect) {
    sedeSelect.addEventListener('change', () => updateSedeHints(sedeSelect.value));
    // intentar llenar en carga
    if (sedeSelect.value) updateSedeHints(sedeSelect.value);
  }

  // Generar rotación
  const formGen = document.getElementById('form-gen');
  const formDelRot = document.getElementById('form-del-rot');
  if (formGen) {
    formGen.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const sede_id = document.getElementById('sede_id').value;
      const ciclo = document.getElementById('ciclo').value;
      const inicio = document.getElementById('inicio').value;
      const msg = document.getElementById('gen-msg');
      msg.textContent = '';
      msg.className = '';

      if (!sede_id || !ciclo || !inicio) {
        msg.textContent = '✗ Complete todos los campos';
        msg.className = 'text-danger';
        return;
      }

      try {
        await api('/api/rotacion/generar/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sede_id, ciclo, inicio })
        });
        msg.textContent = '✓ Rotación generada';
        msg.className = 'text-success';
        cargarEventos();
        // refrescar ciclos en selects de consulta y eliminación
        await (async () => {
          const cicloVal = (ciclo || '').replace('T',' ');
          await loadCyclesForSede(sede_id, qcicloSel, '-- Seleccione un ciclo --');
          await loadCyclesForSede(sede_id, delRotCicloSel, '-- Ciclo --');
          // intentar preseleccionar el recién generado
          if (qcicloSel) {
            const opt = [...qcicloSel.options].find(o => o.value === cicloVal);
            if (opt) qcicloSel.value = cicloVal;
          }
          if (delRotCicloSel) {
            const opt2 = [...delRotCicloSel.options].find(o => o.value === cicloVal);
            if (opt2) delRotCicloSel.value = cicloVal;
          }
        })();
      } catch (e) {
        msg.textContent = '✗ ' + (e.message || e);
        msg.className = 'text-danger';
      }
    });
  }

  // Eliminar rotación
  if (formDelRot) {
    formDelRot.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const sede_id = delRotSede.value;
      const cicloRaw = delRotCicloSel.value;
      const msg = document.getElementById('del-rot-msg');
      msg.textContent=''; msg.className='';
      if (!sede_id || !cicloRaw) { msg.textContent='Complete sede y ciclo'; msg.className='text-danger'; return; }
      const cicloEnc = encodeURIComponent(cicloRaw);
      if (!confirm('¿Eliminar todos los turnos de esa rotación?')) return;
      try {
        const res = await api(`/api/rotacion/eliminar/${encodeURIComponent(sede_id)}/${cicloEnc}/`, { method: 'POST' });
        msg.textContent = `Eliminados ${res.eliminados||0} turno(s).`; msg.className='text-success';
        cargarEventos();
      } catch (e) {
        msg.textContent = e.message || e; msg.className='text-danger';
      }
    });
  }

  // Consultar turnos de un ciclo
  const formQ = document.getElementById('form-q');
  if (formQ) {
    formQ.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const sede_id = (document.getElementById('qsede') || {}).value;
      const qcicloRaw = (qcicloSel || {}).value || '';
      const qciclo = encodeURIComponent(qcicloRaw.trim());
      if (!sede_id || !qcicloRaw) {
        alert('Seleccione una sede y un ciclo');
        return;
      }

      tbody.innerHTML = '';
      turnosBox.classList.add('d-none');
      try {
        const data = await api(`/api/turnos/${encodeURIComponent(sede_id)}/${qciclo}/`);
        const items = Array.isArray(data) ? data : (data.turnos || data.results || []);
        if (!items.length) {
          tbody.innerHTML = `<tr><td colspan="7" class="text-muted">No hay turnos para el ciclo solicitado</td></tr>`;
          turnosBox.classList.remove('d-none');
          return;
        }

        for (const t of items) {
          const tr = document.createElement('tr');
          const tdId = document.createElement('td'); tdId.textContent = t.turno_id ?? '';
          const tdG = document.createElement('td'); tdG.textContent = t.guardia ?? '';
          const tdInicio = document.createElement('td'); tdInicio.textContent = t.inicio ?? '';
          const tdFin = document.createElement('td'); tdFin.textContent = t.fin ?? '';
          const tdHoras = document.createElement('td'); tdHoras.textContent = t.horas ?? '';
          const tdJ = document.createElement('td'); tdJ.textContent = t.jornada ?? '';
          const tdAcc = document.createElement('td');
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-sm btn-outline-danger btn-del';
          btn.dataset.id = t.turno_id ?? '';
          btn.textContent = 'Eliminar';
          tdAcc.appendChild(btn);

          tr.appendChild(tdId);
          tr.appendChild(tdG);
          tr.appendChild(tdInicio);
          tr.appendChild(tdFin);
          tr.appendChild(tdHoras);
          tr.appendChild(tdJ);
          tr.appendChild(tdAcc);
          tbody.appendChild(tr);
        }
        turnosBox.classList.remove('d-none');
      } catch (e) {
        alert(e.message || e);
      }
    });
  }

  // Cargar ciclos por sede y poblar selects
  async function loadCyclesForSede(sedeId, targetSelect, placeholder='-- Ciclo --') {
    if (!targetSelect) return;
    targetSelect.innerHTML = `<option value="">${placeholder}</option>`;
    if (!sedeId) { targetSelect.disabled = true; return; }
    targetSelect.disabled = true;
    try {
      const data = await api(`/api/sedes/${encodeURIComponent(sedeId)}/ciclos/`);
      const ciclos = data.ciclos || [];
      if (!ciclos.length) {
        targetSelect.innerHTML = `<option value="">(Sin ciclos)</option>`;
        targetSelect.disabled = true;
        return;
      }
      targetSelect.innerHTML = `<option value="">${placeholder}</option>` + ciclos.map(c => `<option value="${c}">${c}</option>`).join('');
      targetSelect.disabled = false;
    } catch (e) {
      targetSelect.innerHTML = `<option value="">Error cargando ciclos</option>`;
      targetSelect.disabled = true;
    }
  }

  // Eventos de cambio de sede para cargar ciclos
  if (qsede) qsede.addEventListener('change', () => loadCyclesForSede(qsede.value, qcicloSel, '-- Seleccione un ciclo --'));
  if (delRotSede) delRotSede.addEventListener('change', () => loadCyclesForSede(delRotSede.value, delRotCicloSel, '-- Ciclo --'));

  // Carga inicial si ya hay sede seleccionada
  if (qsede && qsede.value) loadCyclesForSede(qsede.value, qcicloSel, '-- Seleccione un ciclo --');
  if (delRotSede && delRotSede.value) loadCyclesForSede(delRotSede.value, delRotCicloSel, '-- Ciclo --');

  // Delegación para botones Eliminar
  if (tbody) {
    tbody.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('.btn-del');
      if (!btn) return;
      const id = btn.dataset.id;
      if (!id) return;
      if (!confirm(`¿Eliminar turno ${id} y ajustar vecinos?`)) return;
      try {
        await api(`/api/turno/eliminar/${encodeURIComponent(id)}/`, { method: 'POST' });
        btn.closest('tr').remove();
        cargarEventos();
      } catch (e) {
        alert(e.message || e);
      }
    });
  }
});
</script>
{% endblock %}
