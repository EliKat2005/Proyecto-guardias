{% extends "base.html" %}
{% block title %}Inicio - Agencia de Guardias{% endblock %}

{% block content %}
<div class="row g-4 align-items-stretch">
  <div class="col-lg-5">
    <div class="card h-100 card-gradient">
      <div class="card-header fw-bold"><i class="bi bi-arrow-repeat me-2"></i>Generar rotación (24h)</div>
      <div class="card-body">
        <form id="form-gen" class="row g-3">
          {% csrf_token %}
          <div class="col-12">
            <label class="form-label">Sede</label>
            <select class="form-select" id="sede_id" required>
              <option value="">-- Seleccione una sede --</option>
              {% for s in sedes %}
                <option value="{{ s.sede_id }}">{{ s.nombre }} ({{ s.ciudad }})</option>
              {% endfor %}
            </select>
            <div class="form-text">Máximo guardias: <b id="max_guardias_hint">—</b> • Slot: <b id="slot_minutos_hint">—</b> min</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Ciclo (inicio del ciclo 24h)</label>
            <input type="datetime-local" class="form-control" id="ciclo" required>
            <div class="form-text">Ancla del ciclo de 24 horas</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Inicio (hora de arranque)</label>
            <input type="datetime-local" class="form-control" id="inicio" required>
            <div class="form-text">Normalmente igual que ciclo</div>
          </div>
          <div class="col-12">
            <button class="btn btn-primary w-100" type="submit">
              <i class="bi bi-play-circle me-2"></i>Generar rotación
            </button>
            <div id="gen-msg" class="mt-2 small text-center"></div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-lg-7">
    <div class="card h-100">
      <div class="card-header fw-bold"><i class="bi bi-list-check me-2"></i>Consultar turnos de un ciclo</div>
      <div class="card-body">
        <form id="form-q" class="row g-3">
          {% csrf_token %}
          <div class="col-md-6">
            <label class="form-label">Sede</label>
            <select class="form-select" id="qsede" required>
              <option value="">-- Seleccione una sede --</option>
              {% for s in sedes %}
                <option value="{{ s.sede_id }}">{{ s.nombre }} ({{ s.ciudad }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Ciclo (fecha/hora del ciclo)</label>
            <input type="datetime-local" class="form-control" id="qciclo" required>
          </div>
          <div class="col-12">
            <button class="btn btn-secondary w-100" type="submit">
              <i class="bi bi-search me-2"></i>Listar turnos
            </button>
          </div>
        </form>
        <hr/>
        <div id="turnos-box" class="d-none">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Turnos del ciclo</h5>
            <small class="text-muted">Al eliminar, se ajustan turnos vecinos automáticamente</small>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
              <thead>
                <tr>
                  <th>ID</th><th>Guardia</th><th>Inicio</th><th>Fin</th><th>Horas</th><th>Jornada</th><th></th>
                </tr>
              </thead>
              <tbody id="turnos-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<hr class="my-4"/>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span><i class="bi bi-clock-history me-2"></i>Eventos Recientes del Sistema</span>
    <button class="btn btn-sm btn-outline-secondary" id="btn-refresh-eventos">
      <i class="bi bi-arrow-clockwise"></i>
    </button>
  </div>
  <div class="card-body">
    <pre id="eventos" class="mono small bg-light p-3 border rounded" style="max-height: 260px; overflow:auto;">Cargando…</pre>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Elementos cacheados
  const tbody = document.getElementById('turnos-tbody');
  const turnosBox = document.getElementById('turnos-box');
  const eventosPre = document.getElementById('eventos');
  const sedeSelect = document.getElementById('sede_id');
  const hintMax = document.getElementById('max_guardias_hint');
  const hintSlot = document.getElementById('slot_minutos_hint');
  const qsede = document.getElementById('qsede');
  const btnRefreshEventos = document.getElementById('btn-refresh-eventos');

  // Cargar y mostrar eventos recientes
  async function cargarEventos() {
    try {
      const data = await api('/api/reportes/eventos/');
      eventosPre.textContent = JSON.stringify(data, null, 2);
    } catch (e) {
      eventosPre.textContent = e.message || String(e);
    }
  }
  cargarEventos();
  if (btnRefreshEventos) btnRefreshEventos.addEventListener('click', cargarEventos);

  // Mostrar metadatos de la sede seleccionada (si la API lo soporta)
  async function updateSedeHints(id) {
    if (!id) {
      hintMax.textContent = '—';
      hintSlot.textContent = '—';
      return;
    }
    try {
      const s = await api(`/api/sedes/${encodeURIComponent(id)}/`);
      hintMax.textContent = s.max_guardias ?? s.max_guardias_permitidos ?? '—';
      hintSlot.textContent = s.slot_minutos ?? s.slot_min ?? '—';
    } catch (e) {
      // not critical
      hintMax.textContent = '—';
      hintSlot.textContent = '—';
    }
  }
  if (sedeSelect) {
    sedeSelect.addEventListener('change', () => updateSedeHints(sedeSelect.value));
    // intentar llenar en carga
    if (sedeSelect.value) updateSedeHints(sedeSelect.value);
  }

  // Generar rotación
  const formGen = document.getElementById('form-gen');
  if (formGen) {
    formGen.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const sede_id = document.getElementById('sede_id').value;
      const ciclo = document.getElementById('ciclo').value;
      const inicio = document.getElementById('inicio').value;
      const msg = document.getElementById('gen-msg');
      msg.textContent = '';
      msg.className = '';

      if (!sede_id || !ciclo || !inicio) {
        msg.textContent = '✗ Complete todos los campos';
        msg.className = 'text-danger';
        return;
      }

      try {
        await api('/api/rotacion/generar/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sede_id, ciclo, inicio })
        });
        msg.textContent = '✓ Rotación generada';
        msg.className = 'text-success';
        cargarEventos();
      } catch (e) {
        msg.textContent = '✗ ' + (e.message || e);
        msg.className = 'text-danger';
      }
    });
  }

  // Consultar turnos de un ciclo
  const formQ = document.getElementById('form-q');
  if (formQ) {
    formQ.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const sede_id = (document.getElementById('qsede') || {}).value;
      const qcicloRaw = (document.getElementById('qciclo') || {}).value || '';
      const qciclo = encodeURIComponent(qcicloRaw.trim());
      if (!sede_id || !qcicloRaw) {
        alert('Seleccione una sede y un ciclo');
        return;
      }

      tbody.innerHTML = '';
      turnosBox.classList.add('d-none');
      try {
        const data = await api(`/api/turnos/${encodeURIComponent(sede_id)}/${qciclo}/`);
        const items = Array.isArray(data) ? data : (data.turnos || data.results || []);
        if (!items.length) {
          tbody.innerHTML = `<tr><td colspan="7" class="text-muted">No hay turnos para el ciclo solicitado</td></tr>`;
          turnosBox.classList.remove('d-none');
          return;
        }

        for (const t of items) {
          const tr = document.createElement('tr');
          const tdId = document.createElement('td'); tdId.textContent = t.turno_id ?? '';
          const tdG = document.createElement('td'); tdG.textContent = t.guardia ?? '';
          const tdInicio = document.createElement('td'); tdInicio.textContent = t.inicio ?? '';
          const tdFin = document.createElement('td'); tdFin.textContent = t.fin ?? '';
          const tdHoras = document.createElement('td'); tdHoras.textContent = t.horas ?? '';
          const tdJ = document.createElement('td'); tdJ.textContent = t.jornada ?? '';
          const tdAcc = document.createElement('td');
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-sm btn-outline-danger btn-del';
          btn.dataset.id = t.turno_id ?? '';
          btn.textContent = 'Eliminar';
          tdAcc.appendChild(btn);

          tr.appendChild(tdId);
          tr.appendChild(tdG);
          tr.appendChild(tdInicio);
          tr.appendChild(tdFin);
          tr.appendChild(tdHoras);
          tr.appendChild(tdJ);
          tr.appendChild(tdAcc);
          tbody.appendChild(tr);
        }
        turnosBox.classList.remove('d-none');
      } catch (e) {
        alert(e.message || e);
      }
    });
  }

  // Delegación para botones Eliminar
  if (tbody) {
    tbody.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('.btn-del');
      if (!btn) return;
      const id = btn.dataset.id;
      if (!id) return;
      if (!confirm(`¿Eliminar turno ${id} y ajustar vecinos?`)) return;
      try {
        await api(`/api/turno/eliminar/${encodeURIComponent(id)}/`, { method: 'POST' });
        btn.closest('tr').remove();
        cargarEventos();
      } catch (e) {
        alert(e.message || e);
      }
    });
  }
});
</script>
{% endblock %}
